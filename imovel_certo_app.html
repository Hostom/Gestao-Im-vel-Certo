<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Capta√ß√£o - Im√≥vel Certo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:,">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .kanban-column { min-width: 300px; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURA√á√ÉO DA API (CORRIGIDA) ---
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001' 
            : `${window.location.protocol}//${window.location.host}`;
        
        // Log para debug
        console.log('API_URL configurada:', API_URL);
        console.log('Ambiente:', window.location.hostname);
        // -------------------------

        const { useState, useEffect, useCallback, useMemo } = React;

        // Componente de √≠cone simples usando emojis
        const Icon = ({ name }) => {
            const icons = {
                'BarChart2': 'üìä',
                'FilePlus': 'üìÑ',
                'Columns': 'üìã',
                'Trophy': 'üèÜ',
                'Clock': '‚è∞',
                'User': 'üë§',
                'Phone': 'üìû',
                'MapPin': 'üìç',
                'Star': '‚≠ê',
                'Building': 'üè¢',
                'Briefcase': 'üíº',
                'Calendar': 'üìÖ',
                'Users': 'üë•',
                'Settings': '‚öôÔ∏è',
                'LogOut': 'üö™',
                'Lock': 'üîí',
                'MessageSquare': 'üí¨',
                'Plus': '‚ûï',
                'Eye': 'üëÅÔ∏è',
                'Edit': '‚úèÔ∏è',
                'Check': '‚úÖ',
                'X': '‚ùå',
                'Search': 'üîç',
                'Filter': 'üîΩ'
            };
            return <span className="mr-2">{icons[name] || '‚Ä¢'}</span>;
        };

        // Utilit√°rio para fazer requisi√ß√µes autenticadas
       const apiRequest = async (endpoint, options = {}) => {
  const token = localStorage.getItem('token');
  const headers = {
    'Content-Type': 'application/json',
    ...(token && { 'Authorization': `Bearer ${token}` }),
    ...options.headers,
  };

  try {
    const response = await fetch(`${API_URL}${endpoint}`, {
      ...options,
      headers,
      body: options.body ? (typeof options.body === 'string' ? options.body : JSON.stringify(options.body)) : undefined,
    });

    // Se o token expirou ou for inv√°lido
    if (response.status === 401 || response.status === 403) {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      alert('Sess√£o expirada. Fa√ßa login novamente.');
      window.location.reload();
      // Retornar uma Promise que nunca resolve para evitar que o c√≥digo continue
      return new Promise(() => {});
    }

    return response;
  } catch (error) {
    console.error('Erro na requisi√ß√£o:', error);
    throw new Error('Erro de conex√£o com o servidor');
  }
};


        // Context para autentica√ß√£o
        const AuthContext = React.createContext();

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
  const token = localStorage.getItem('token');
  const userData = localStorage.getItem('user');

  if (token && userData) {
    const user = JSON.parse(userData);
    setUser(user);

    // üü¶ Ajuste para garantir que o cargo seja reconhecido corretamente
    const cargo = user?.cargo || 'captador';
    localStorage.setItem('role', cargo);
    console.log('Cargo carregado:', cargo);
  }

  setLoading(false);
}, []); // ‚úÖ fecha corretamente o useEffect


            const login = async (email, senha) => {
                try {
                    const response = await fetch(`${API_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, senha }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Erro no login');
                    }

                    const data = await response.json();
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    const cargo = data.user.cargo;

                    if (cargo === 'diretor') {
                         localStorage.setItem('role', 'diretor');
                     } else if (cargo === 'gerente_regional') {
                         localStorage.setItem('role', 'gerente');
                } else {
                          localStorage.setItem('role', 'captador');
                }
                    
                    console.log('Cargo definido:', cargo);    
                    setUser(data.user);
                    return data;
                } catch (error) {
                    console.error('Erro no login:', error);
                    throw error;
                }
            };

            const logout = () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                setUser(null);
            };

            return (
                <AuthContext.Provider value={{ user, login, logout, loading }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        const useAuth = () => {
            const context = React.useContext(AuthContext);
            if (!context) {
                throw new Error('useAuth deve ser usado dentro de AuthProvider');
            }
            return context;
        };

        // Componente de Login
        const LoginForm = () => {
            const [email, setEmail] = useState('');
            const [senha, setSenha] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const { login } = useAuth();

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    await login(email, senha);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                    <div className="max-w-md w-full space-y-8">
                        <div>
                            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                Im√≥vel Certo
                            </h2>
                            <p className="mt-2 text-center text-sm text-gray-600">
                                Sistema de Gest√£o de Capta√ß√£o
                            </p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div>
                                    <input
                                        id="email"
                                        name="email"
                                        type="email"
                                        required
                                        className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                        placeholder="Email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                    />
                                </div>
                                <div>
                                    <input
                                        id="senha"
                                        name="senha"
                                        type="password"
                                        required
                                        className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                        placeholder="Senha"
                                        value={senha}
                                        onChange={(e) => setSenha(e.target.value)}
                                    />
                                </div>
                            </div>

                            {error && (
                                <div className="text-red-600 text-sm text-center">
                                    {error}
                                </div>
                            )}

                            <div>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                                >
                                    <Icon name="Lock" />
                                    {loading ? 'Entrando...' : 'Entrar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Componente de Layout Principal
        const Layout = ({ children }) => {
            const { user, logout } = useAuth();
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [dropdownOpen, setDropdownOpen] = useState(false);

            const userRole = localStorage.getItem('role');

            const navigation = useMemo(() => [
                { name: 'Dashboard', href: '#', icon: 'BarChart2', current: true, roles: ['admin', 'diretor', 'gerente', 'captador'] },
                { name: 'Demandas', href: '#demandas', icon: 'FilePlus', current: false, roles: ['admin', 'diretor', 'gerente', 'captador'] },
                { name: 'Miss√µes', href: '#missoes', icon: 'Columns', current: false, roles: ['admin', 'diretor', 'gerente', 'captador'] },
                { name: 'Usu√°rios', href: '#usuarios', icon: 'Users', current: false, roles: ['admin', 'diretor', 'gerente'] },
                { name: 'Relat√≥rios', href: '#relatorios', icon: 'Trophy', current: false, roles: ['admin', 'diretor', 'gerente'] },
                { name: 'Configura√ß√µes', href: '#configuracoes', icon: 'Settings', current: false, roles: ['admin', 'diretor'] },
            ], []);

            const filteredNavigation = useMemo(() => {
                if (!userRole) return [];
                return navigation.filter(item => item.roles.includes(userRole));
            }, [userRole, navigation]);

            return (
                <div className="min-h-screen flex">
                    {/* Sidebar para desktop */}
                    <div className="hidden md:flex md:flex-shrink-0">
                        <div className="flex flex-col w-64">
                            <div className="flex flex-col h-0 flex-1 border-r border-gray-200 bg-white">
                                <div className="flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
                                    <div className="flex items-center flex-shrink-0 px-4">
                                        <h1 className="text-2xl font-bold text-blue-600">Im√≥vel Certo</h1>
                                    </div>
                                    <nav className="mt-5 flex-1 px-2 bg-white space-y-1">
                                        {filteredNavigation.map((item) => (
                                            <a
                                                key={item.name}
                                                href={item.href}
                                                className={`group flex items-center px-2 py-2 text-sm font-medium rounded-md
                                                    ${item.current ? 'bg-gray-100 text-gray-900' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}
                                            >
                                                <Icon name={item.icon} />
                                                {item.name}
                                            </a>
                                        ))}
                                    </nav>
                                </div>
                                <div className="flex-shrink-0 flex border-t border-gray-200 p-4">
                                    <a href="#" className="flex-shrink-0 w-full group block">
                                        <div className="flex items-center">
                                            <div>
                                                <Icon name="User" />
                                            </div>
                                            <div className="ml-3">
                                                <p className="text-sm font-medium text-gray-700 group-hover:text-gray-900">{user?.nome || 'Usu√°rio'}</p>
                                                <p className="text-xs font-medium text-gray-500 group-hover:text-gray-700">{user?.email || 'email@example.com'}</p>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Sidebar para mobile */}
                    {sidebarOpen && (
                        <div className="fixed inset-0 flex z-40 md:hidden" role="dialog" aria-modal="true">
                            <div className="fixed inset-0 bg-gray-600 bg-opacity-75" aria-hidden="true" onClick={() => setSidebarOpen(false)}></div>
                            <div className="relative flex-1 flex flex-col max-w-xs w-full bg-white">
                                <div className="absolute top-0 right-0 -mr-12 pt-2">
                                    <button
                                        type="button"
                                        className="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
                                        onClick={() => setSidebarOpen(false)}
                                    >
                                        <span className="sr-only">Fechar sidebar</span>
                                        <Icon name="X" />
                                    </button>
                                </div>
                                <div className="flex-1 h-0 pt-5 pb-4 overflow-y-auto">
                                    <div className="flex-shrink-0 flex items-center px-4">
                                        <h1 className="text-2xl font-bold text-blue-600">Im√≥vel Certo</h1>
                                    </div>
                                    <nav className="mt-5 px-2 space-y-1">
                                        {filteredNavigation.map((item) => (
                                            <a
                                                key={item.name}
                                                href={item.href}
                                                className={`group flex items-center px-2 py-2 text-base font-medium rounded-md
                                                    ${item.current ? 'bg-gray-100 text-gray-900' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}
                                            >
                                                <Icon name={item.icon} />
                                                {item.name}
                                            </a>
                                        ))}
                                    </nav>
                                </div>
                                <div className="flex-shrink-0 flex border-t border-gray-200 p-4">
                                    <a href="#" className="flex-shrink-0 w-full group block">
                                        <div className="flex items-center">
                                            <div>
                                                <Icon name="User" />
                                            </div>
                                            <div className="ml-3">
                                                <p className="text-sm font-medium text-gray-700 group-hover:text-gray-900">{user?.nome || 'Usu√°rio'}</p>
                                                <p className="text-xs font-medium text-gray-500 group-hover:text-gray-700">{user?.email || 'email@example.com'}</p>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main content */}
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <div className="relative z-10 flex-shrink-0 flex h-16 bg-white shadow">
                            <button
                                type="button"
                                className="px-4 border-r border-gray-200 text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 md:hidden"
                                onClick={() => setSidebarOpen(true)}
                            >
                                <span className="sr-only">Abrir sidebar</span>
                                <Icon name="Columns" />
                            </button>
                            <div className="flex-1 px-4 flex justify-between">
                                <div className="flex-1 flex"></div>
                                <div className="ml-4 flex items-center md:ml-6">
                                    <div className="ml-3 relative">
                                        <div>
                                            <button
                                                type="button"
                                                className="max-w-xs bg-white flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                                id="user-menu-button"
                                                aria-expanded="false"
                                                aria-haspopup="true"
                                                onClick={() => setDropdownOpen(!dropdownOpen)}
                                            >
                                                <span className="sr-only">Abrir menu do usu√°rio</span>
                                                <Icon name="User" />
                                                <span className="ml-2 text-sm font-medium text-gray-700">{user?.nome || 'Usu√°rio'}</span>
                                            </button>
                                        </div>
                                        {dropdownOpen && (
                                            <div
                                                className="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none"
                                                role="menu"
                                                aria-orientation="vertical"
                                                aria-labelledby="user-menu-button"
                                            >
                                                <a href="#" className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Seu Perfil</a>
                                                <button
                                                    onClick={logout}
                                                    className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                    role="menuitem"
                                                >
                                                    Sair
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <main className="flex-1 overflow-y-auto">
                            {children}
                        </main>
                    </div>
                </div>
            );
        };

        // Componente de Dashboard
        const Dashboard = () => {
            const { user } = useAuth();
            const [demandasCount, setDemandasCount] = useState(0);
            const [missoesCount, setMissoesCount] = useState(0);
            const [usuariosCount, setUsuariosCount] = useState(0);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const userRole = localStorage.getItem('role');
            const userId = user?.id;

            useEffect(() => {
                const fetchCounts = async () => {
                    try {
                        setLoading(true);
                        setError(null);

                        let demandasEndpoint = '/api/demandas/count';
                        let missoesEndpoint = '/api/missoes/count';
                        let usuariosEndpoint = '/api/usuarios/count';

                        if (userRole === 'gerente') {
                            demandasEndpoint = `/api/demandas/count?gerenteId=${userId}`;
                            missoesEndpoint = `/api/missoes/count?gerenteId=${userId}`;
                            usuariosEndpoint = `/api/usuarios/count?gerenteId=${userId}`;
                        } else if (userRole === 'captador') {
                            demandasEndpoint = `/api/demandas/count?captadorId=${userId}`;
                            missoesEndpoint = `/api/missoes/count?captadorId=${userId}`;
                        }

                        const [demandasRes, missoesRes, usuariosRes] = await Promise.all([
                            apiRequest(demandasEndpoint),
                            apiRequest(missoesEndpoint),
                            apiRequest(usuariosEndpoint)
                        ]);

                        const demandasData = await demandasRes.json();
                        const missoesData = await missoesRes.json();
                        const usuariosData = await usuariosRes.json();

                        setDemandasCount(demandasData.count);
                        setMissoesCount(missoesData.count);
                        setUsuariosCount(usuariosData.count);

                    } catch (err) {
                        console.error('Erro ao buscar contagens:', err);
                        setError('N√£o foi poss√≠vel carregar os dados do dashboard.');
                    } finally {
                        setLoading(false);
                    }
                };

                if (user) {
                    fetchCounts();
                }
            }, [user, userRole, userId]);

            if (loading) return <div className="p-6 text-center">Carregando dashboard...</div>;
            if (error) return <div className="p-6 text-center text-red-600">Erro: {error}</div>;

            return (
                <div className="p-6">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6">Dashboard</h1>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white overflow-hidden shadow rounded-lg">
                            <div className="px-4 py-5 sm:p-6">
                                <div className="flex items-center">
                                    <div className="flex-shrink-0 bg-blue-500 rounded-md p-3">
                                        <Icon name="FilePlus" />
                                    </div>
                                    <div className="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt className="text-sm font-medium text-gray-500">Demandas Ativas</dt>
                                            <dd className="text-3xl font-bold text-gray-900">{demandasCount}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white overflow-hidden shadow rounded-lg">
                            <div className="px-4 py-5 sm:p-6">
                                <div className="flex items-center">
                                    <div className="flex-shrink-0 bg-green-500 rounded-md p-3">
                                        <Icon name="Columns" />
                                    </div>
                                    <div className="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt className="text-sm font-medium text-gray-500">Miss√µes em Andamento</dt>
                                            <dd className="text-3xl font-bold text-gray-900">{missoesCount}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {userRole !== 'captador' && (
                            <div className="bg-white overflow-hidden shadow rounded-lg">
                                <div className="px-4 py-5 sm:p-6">
                                    <div className="flex items-center">
                                        <div className="flex-shrink-0 bg-purple-500 rounded-md p-3">
                                            <Icon name="Users" />
                                        </div>
                                        <div className="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt className="text-sm font-medium text-gray-500">Usu√°rios Ativos</dt>
                                                <dd className="text-3xl font-bold text-gray-900">{usuariosCount}</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Componente de Gerenciamento de Demandas
        const Demandas = () => {
            const { user } = useAuth();
            const [demandas, setDemandas] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentDemanda, setCurrentDemanda] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterRegiao, setFilterRegiao] = useState('');
            const [regioesDisponiveis, setRegioesDisponiveis] = useState([]);

            const userRole = localStorage.getItem('role');
            const userId = user?.id;

            const fetchDemandas = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);
                    let endpoint = '/api/demandas';

                    if (userRole === 'gerente') {
                        endpoint = `/api/demandas?gerenteId=${userId}`;
                    } else if (userRole === 'captador') {
                        endpoint = `/api/demandas?captadorId=${userId}`;
                    }

                    const response = await apiRequest(endpoint);
                    const data = await response.json();
                    setDemandas(data);
                } catch (err) {
                    console.error('Erro ao buscar demandas:', err);
                    setError('N√£o foi poss√≠vel carregar as demandas.');
                } finally {
                    setLoading(false);
                }
            }, [userRole, userId]);

            const fetchRegioes = useCallback(async () => {
                try {
                    const response = await apiRequest('/api/regioes');
                    const data = await response.json();
                    setRegioesDisponiveis(data.map(r => r.regiao));
                } catch (err) {
                    console.error('Erro ao buscar regi√µes:', err);
                }
            }, []);

            useEffect(() => {
                if (user) {
                    fetchDemandas();
                    fetchRegioes();
                }
            }, [user, fetchDemandas, fetchRegioes]);

            const handleEdit = (demanda) => {
                setCurrentDemanda(demanda);
                setIsModalOpen(true);
            };

            const handleDelete = async (id) => {
                if (window.confirm('Tem certeza que deseja excluir esta demanda?')) {
                    try {
                        await apiRequest(`/api/demandas/${id}`, { method: 'DELETE' });
                        fetchDemandas();
                    } catch (err) {
                        console.error('Erro ao excluir demanda:', err);
                        setError('N√£o foi poss√≠vel excluir a demanda.');
                    }
                }
            };

            const handleSave = async (demandaData) => {
                try {
                    if (demandaData.id) {
                        await apiRequest(`/api/demandas/${demandaData.id}`, {
                            method: 'PUT',
                            body: demandaData,
                        });
                    } else {
                        await apiRequest('/api/demandas', {
                            method: 'POST',
                            body: { ...demandaData, criado_por_id: user.id },
                        });
                    }
                    fetchDemandas();
                    setIsModalOpen(false);
                    setCurrentDemanda(null);
                } catch (err) {
                    console.error('Erro ao salvar demanda:', err);
                    setError('N√£o foi poss√≠vel salvar a demanda.');
                }
            };

            const filteredDemandas = useMemo(() => {
                return demandas.filter(demanda => {
                    const matchesSearch = searchTerm === '' ||
                        demanda.codigo_demanda.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        demanda.cliente_interessado.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        demanda.consultor_locacao.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesRegion = filterRegiao === '' || demanda.regiao_demanda === filterRegiao;
                    return matchesSearch && matchesRegion;
                });
            }, [demandas, searchTerm, filterRegiao]);

            if (loading) return <div className="p-6 text-center">Carregando demandas...</div>;
            if (error) return <div className="p-6 text-center text-red-600">Erro: {error}</div>;

            return (
                <div className="p-6">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6">Gerenciamento de Demandas</h1>

                    <div className="flex justify-between items-center mb-4">
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                placeholder="Buscar demandas..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            />
                            <select
                                value={filterRegiao}
                                onChange={(e) => setFilterRegiao(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            >
                                <option value="">Todas as Regi√µes</option>
                                {regioesDisponiveis.map(regiao => (
                                    <option key={regiao} value={regiao}>{regiao}</option>
                                ))}
                            </select>
                        </div>
                        <button
                            onClick={() => { setCurrentDemanda(null); setIsModalOpen(true); }}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center"
                        >
                            <Icon name="Plus" /> Nova Demanda
                        </button>
                    </div>

                    <div className="bg-white shadow overflow-hidden sm:rounded-lg">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Consultor</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo Im√≥vel</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Regi√£o</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluguel</th>
                                    <th scope="col" className="relative px-6 py-3"><span className="sr-only">A√ß√µes</span></th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {filteredDemandas.map((demanda) => (
                                    <tr key={demanda.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{demanda.codigo_demanda}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{demanda.cliente_interessado}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{demanda.consultor_locacao}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{demanda.tipo_imovel}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{demanda.regiao_demanda}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{demanda.faixa_aluguel}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => handleEdit(demanda)} className="text-blue-600 hover:text-blue-900 mr-3"><Icon name="Edit" /></button>
                                            <button onClick={() => handleDelete(demanda.id)} className="text-red-600 hover:text-red-900"><Icon name="X" /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {isModalOpen && (
                        <DemandaModal
                            demanda={currentDemanda}
                            onSave={handleSave}
                            onClose={() => setIsModalOpen(false)}
                            regioesDisponiveis={regioesDisponiveis}
                        />
                    )}
                </div>
            );
        };

        // Modal para Adicionar/Editar Demanda
        const DemandaModal = ({ demanda, onSave, onClose, regioesDisponiveis }) => {
            const [formData, setFormData] = useState(demanda || {
                codigo_demanda: '',
                consultor_locacao: '',
                cliente_interessado: '',
                contato: '',
                tipo_imovel: '',
                regiao_desejada: '',
                regiao_demanda: '',
                faixa_aluguel: '',
                caracteristicas_desejadas: '',
                prazo_necessidade: '',
                observacoes: '',
            });

            useEffect(() => {
                setFormData(demanda || {
                    codigo_demanda: '',
                    consultor_locacao: '',
                    cliente_interessado: '',
                    contato: '',
                    tipo_imovel: '',
                    regiao_desejada: '',
                    regiao_demanda: '',
                    faixa_aluguel: '',
                    caracteristicas_desejadas: '',
                    prazo_necessidade: '',
                    observacoes: '',
                });
            }, [demanda]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
                    <div className="relative p-8 border w-full max-w-2xl md:max-w-3xl shadow-lg rounded-md bg-white">
                        <h3 className="text-lg font-medium leading-6 text-gray-900 mb-4">
                            {demanda ? 'Editar Demanda' : 'Nova Demanda'}
                        </h3>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label htmlFor="codigo_demanda" className="block text-sm font-medium text-gray-700">C√≥digo da Demanda</label>
                                <input type="text" name="codigo_demanda" id="codigo_demanda" value={formData.codigo_demanda} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="consultor_locacao" className="block text-sm font-medium text-gray-700">Consultor de Loca√ß√£o</label>
                                <input type="text" name="consultor_locacao" id="consultor_locacao" value={formData.consultor_locacao} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="cliente_interessado" className="block text-sm font-medium text-gray-700">Cliente Interessado</label>
                                <input type="text" name="cliente_interessado" id="cliente_interessado" value={formData.cliente_interessado} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="contato" className="block text-sm font-medium text-gray-700">Contato</label>
                                <input type="text" name="contato" id="contato" value={formData.contato} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="tipo_imovel" className="block text-sm font-medium text-gray-700">Tipo de Im√≥vel</label>
                                <input type="text" name="tipo_imovel" id="tipo_imovel" value={formData.tipo_imovel} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="regiao_desejada" className="block text-sm font-medium text-gray-700">Regi√£o Desejada</label>
                                <input type="text" name="regiao_desejada" id="regiao_desejada" value={formData.regiao_desejada} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="regiao_demanda" className="block text-sm font-medium text-gray-700">Regi√£o da Demanda</label>
                                <select name="regiao_demanda" id="regiao_demanda" value={formData.regiao_demanda} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                    <option value="">Selecione uma regi√£o</option>
                                    {regioesDisponiveis.map(regiao => (
                                        <option key={regiao} value={regiao}>{regiao}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label htmlFor="faixa_aluguel" className="block text-sm font-medium text-gray-700">Faixa de Aluguel</label>
                                <input type="text" name="faixa_aluguel" id="faixa_aluguel" value={formData.faixa_aluguel} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div className="md:col-span-2">
                                <label htmlFor="caracteristicas_desejadas" className="block text-sm font-medium text-gray-700">Caracter√≠sticas Desejadas</label>
                                <textarea name="caracteristicas_desejadas" id="caracteristicas_desejadas" value={formData.caracteristicas_desejadas} onChange={handleChange} rows="3" className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                            </div>
                            <div>
                                <label htmlFor="prazo_necessidade" className="block text-sm font-medium text-gray-700">Prazo de Necessidade</label>
                                <input type="text" name="prazo_necessidade" id="prazo_necessidade" value={formData.prazo_necessidade} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div className="md:col-span-2">
                                <label htmlFor="observacoes" className="block text-sm font-medium text-gray-700">Observa√ß√µes</label>
                                <textarea name="observacoes" id="observacoes" value={formData.observacoes} onChange={handleChange} rows="3" className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                            </div>
                            <div className="md:col-span-2 flex justify-end space-x-3 mt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    className="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Componente de Gerenciamento de Miss√µes
        const Missoes = () => {
            const { user } = useAuth();
            const [missoes, setMissoes] = useState([]);
            const [demandas, setDemandas] = useState([]); // Para buscar c√≥digos de demanda
            const [usuarios, setUsuarios] = useState([]); // Para buscar captadores
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentMissao, setCurrentMissao] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('');
            const [filterCaptador, setFilterCaptador] = useState('');
            const [filterRegiao, setFilterRegiao] = useState('');
            const [regioesDisponiveis, setRegioesDisponiveis] = useState([]);

            const userRole = localStorage.getItem('role');
            const userId = user?.id;

            const fetchMissoes = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);
                    let endpoint = '/api/missoes';

                    if (userRole === 'gerente') {
                        endpoint = `/api/missoes?gerenteId=${userId}`;
                    } else if (userRole === 'captador') {
                        endpoint = `/api/missoes?captadorId=${userId}`;
                    }

                    const response = await apiRequest(endpoint);
                    const data = await response.json();
                    setMissoes(data);
                } catch (err) {
                    console.error('Erro ao buscar miss√µes:', err);
                    setError('N√£o foi poss√≠vel carregar as miss√µes.');
                } finally {
                    setLoading(false);
                }
            }, [userRole, userId]);

            const fetchDemandasAndUsuarios = useCallback(async () => {
                try {
                    const [demandasRes, usuariosRes, regioesRes] = await Promise.all([
                        apiRequest('/api/demandas'),
                        apiRequest('/api/usuarios?tipo=captador'),
                        apiRequest('/api/regioes')
                    ]);
                    const demandasData = await demandasRes.json();
                    const usuariosData = await usuariosRes.json();
                    const regioesData = await regioesRes.json();
                    setDemandas(demandasData);
                    setUsuarios(usuariosData);
                    setRegioesDisponiveis(regioesData.map(r => r.regiao));
                } catch (err) {
                    console.error('Erro ao buscar dados de apoio para miss√µes:', err);
                }
            }, []);

            useEffect(() => {
                if (user) {
                    fetchMissoes();
                    fetchDemandasAndUsuarios();
                }
            }, [user, fetchMissoes, fetchDemandasAndUsuarios]);

            const handleEdit = (missao) => {
                setCurrentMissao(missao);
                setIsModalOpen(true);
            };

            const handleDelete = async (id) => {
                if (window.confirm('Tem certeza que deseja excluir esta miss√£o?')) {
                    try {
                        await apiRequest(`/api/missoes/${id}`, { method: 'DELETE' });
                        fetchMissoes();
                    } catch (err) {
                        console.error('Erro ao excluir miss√£o:', err);
                        setError('N√£o foi poss√≠vel excluir a miss√£o.');
                    }
                }
            };

            const handleSave = async (missaoData) => {
                try {
                    if (missaoData.id) {
                        await apiRequest(`/api/missoes/${missaoData.id}`, {
                            method: 'PUT',
                            body: missaoData,
                        });
                    } else {
                        await apiRequest('/api/missoes', {
                            method: 'POST',
                            body: { ...missaoData, criado_por_id: user.id },
                        });
                    }
                    fetchMissoes();
                    setIsModalOpen(false);
                    setCurrentMissao(null);
                } catch (err) {
                    console.error('Erro ao salvar miss√£o:', err);
                    setError('N√£o foi poss√≠vel salvar a miss√£o.');
                }
            };

            const syncMissions = async () => {
                if (window.confirm('Deseja sincronizar as demandas com miss√µes? Isso criar√° miss√µes para demandas sem miss√µes associadas.')) {
                    try {
                        await apiRequest('/api/missoes/sync-from-demandas', { method: 'POST' });
                        alert('Sincroniza√ß√£o iniciada com sucesso!');
                        fetchMissoes();
                    } catch (err) {
                        console.error('Erro ao sincronizar miss√µes:', err);
                        alert('Erro ao sincronizar miss√µes: ' + (err.message || 'Verifique o console para mais detalhes.'));
                    }
                }
            };

            const filteredMissoes = useMemo(() => {
                return missoes.filter(missao => {
                    const matchesSearch = searchTerm === '' ||
                        missao.codigo_demanda.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        missao.captador_responsavel.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        missao.consultor_solicitante.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesStatus = filterStatus === '' || missao.status === filterStatus;
                    const matchesCaptador = filterCaptador === '' || String(missao.captador_id) === filterCaptador;
                    const matchesRegiao = filterRegiao === '' || missao.regiao_bairro === filterRegiao;
                    return matchesSearch && matchesStatus && matchesCaptador && matchesRegiao;
                });
            }, [missoes, searchTerm, filterStatus, filterCaptador, filterRegiao]);

            if (loading) return <div className="p-6 text-center">Carregando miss√µes...</div>;
            if (error) return <div className="p-6 text-center text-red-600">Erro: {error}</div>;

            return (
                <div className="p-6">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6">Gerenciamento de Miss√µes</h1>

                    <div className="flex justify-between items-center mb-4">
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                placeholder="Buscar miss√µes..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            />
                            <select
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            >
                                <option value="">Todos os Status</option>
                                <option value="Em busca">Em busca</option>
                                <option value="Encontrado">Encontrado</option>
                                <option value="Locado">Locado</option>
                            </select>
                            <select
                                value={filterCaptador}
                                onChange={(e) => setFilterCaptador(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            >
                                <option value="">Todos os Captadores</option>
                                {usuarios.map(u => (
                                    <option key={u.id} value={u.id}>{u.nome}</option>
                                ))}
                            </select>
                            <select
                                value={filterRegiao}
                                onChange={(e) => setFilterRegiao(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            >
                                <option value="">Todas as Regi√µes</option>
                                {regioesDisponiveis.map(regiao => (
                                    <option key={regiao} value={regiao}>{regiao}</option>
                                ))}
                            </select>
                        </div>
                        <button
                            onClick={() => { setCurrentMissao(null); setIsModalOpen(true); }}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center"
                        >
                            <Icon name="Plus" /> Nova Miss√£o
                        </button>
                    </div>

                    {userRole !== 'captador' && (
                        <div className="flex justify-end mb-4">
                            <button
                                onClick={syncMissions}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium"
                            >
                                üîÑ Sincronizar Demandas com Miss√µes
                            </button>
                            <span className="ml-3 text-sm text-gray-600">
                                Clique para criar miss√µes para demandas que ainda n√£o possuem.
                            </span>
                        </div>
                    )}

                    <div className="bg-white shadow overflow-hidden sm:rounded-lg">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo Demanda</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Captador</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Consultor</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Regi√£o/Bairro</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" className="relative px-6 py-3"><span className="sr-only">A√ß√µes</span></th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {filteredMissoes.map((missao) => (
                                    <tr key={missao.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{missao.codigo_demanda}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{missao.captador_responsavel}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{missao.consultor_solicitante}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{missao.regiao_bairro}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{missao.status}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => handleEdit(missao)} className="text-blue-600 hover:text-blue-900 mr-3"><Icon name="Edit" /></button>
                                            <button onClick={() => handleDelete(missao.id)} className="text-red-600 hover:text-red-900"><Icon name="X" /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {isModalOpen && (
                        <MissaoModal
                            missao={currentMissao}
                            onSave={handleSave}
                            onClose={() => setIsModalOpen(false)}
                            demandas={demandas}
                            usuarios={usuarios}
                            regioesDisponiveis={regioesDisponiveis}
                        />
                    )}
                </div>
            );
        };

        // Modal para Adicionar/Editar Miss√£o
        const MissaoModal = ({ missao, onSave, onClose, demandas, usuarios, regioesDisponiveis }) => {
            const [formData, setFormData] = useState(missao || {
                demanda_id: '',
                codigo_demanda: '',
                captador_responsavel: '',
                captador_id: '',
                consultor_solicitante: '',
                regiao_bairro: '',
                descricao_busca: '',
                status: 'Em busca',
                data_retorno: '',
            });

            useEffect(() => {
                setFormData(missao || {
                    codigo_demanda: '',
                    consultor_locacao: '',
                    cliente_interessado: '',
                    contato: '',
                    tipo_imovel: '',
                    regiao_desejada: '',
                    regiao_demanda: '',
                    faixa_aluguel: '',
                    caracteristicas_desejadas: '',
                    prazo_necessidade: '',
                    observacoes: '',
                });
            }, [missao]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value,
                    // Preencher captador_responsavel e consultor_solicitante automaticamente
                    ...(name === 'captador_id' && { captador_responsavel: usuarios.find(u => String(u.id) === value)?.nome || '' }),
                    ...(name === 'demanda_id' && { codigo_demanda: demandas.find(d => String(d.id) === value)?.codigo_demanda || '' })
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
                    <div className="relative p-8 border w-full max-w-2xl md:max-w-3xl shadow-lg rounded-md bg-white">
                        <h3 className="text-lg font-medium leading-6 text-gray-900 mb-4">
                            {missao ? 'Editar Miss√£o' : 'Nova Miss√£o'}
                        </h3>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label htmlFor="demanda_id" className="block text-sm font-medium text-gray-700">Demanda Associada</label>
                                <select name="demanda_id" id="demanda_id" value={formData.demanda_id} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                    <option value="">Selecione uma demanda</option>
                                    {demandas.map(d => (
                                        <option key={d.id} value={d.id}>{d.codigo_demanda} - {d.cliente_interessado}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label htmlFor="captador_id" className="block text-sm font-medium text-gray-700">Captador Respons√°vel</label>
                                <select name="captador_id" id="captador_id" value={formData.captador_id} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                    <option value="">Selecione um captador</option>
                                    {usuarios.map(u => (
                                        <option key={u.id} value={u.id}>{u.nome}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label htmlFor="consultor_solicitante" className="block text-sm font-medium text-gray-700">Consultor Solicitante</label>
                                <input type="text" name="consultor_solicitante" id="consultor_solicitante" value={formData.consultor_solicitante} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="regiao_bairro" className="block text-sm font-medium text-gray-700">Regi√£o/Bairro</label>
                                <select name="regiao_bairro" id="regiao_bairro" value={formData.regiao_bairro} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                    <option value="">Selecione uma regi√£o</option>
                                    {regioesDisponiveis.map(regiao => (
                                        <option key={regiao} value={regiao}>{regiao}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="md:col-span-2">
                                <label htmlFor="descricao_busca" className="block text-sm font-medium text-gray-700">Descri√ß√£o da Busca</label>
                                <textarea name="descricao_busca" id="descricao_busca" value={formData.descricao_busca} onChange={handleChange} rows="3" className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required></textarea>
                            </div>
                            <div>
                                <label htmlFor="status" className="block text-sm font-medium text-gray-700">Status</label>
                                <select name="status" id="status" value={formData.status} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                    <option value="Em busca">Em busca</option>
                                    <option value="Encontrado">Encontrado</option>
                                    <option value="Locado">Locado</option>
                                </select>
                            </div>
                            <div>
                                <label htmlFor="data_retorno" className="block text-sm font-medium text-gray-700">Data de Retorno (Opcional)</label>
                                <input type="date" name="data_retorno" id="data_retorno" value={formData.data_retorno ? new Date(formData.data_retorno).toISOString().split('T')[0] : ''} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div className="md:col-span-2 flex justify-end space-x-3 mt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    className="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Componente de Gerenciamento de Usu√°rios
        const Usuarios = () => {
            const { user } = useAuth();
            const [usuarios, setUsuarios] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterRole, setFilterRole] = useState('');
            const [filterRegiao, setFilterRegiao] = useState('');
            const [regioesDisponiveis, setRegioesDisponiveis] = useState([]);
            const [gerentesDisponiveis, setGerentesDisponiveis] = useState([]);

            const userRole = localStorage.getItem('role');
            const userId = user?.id;

            const fetchUsuarios = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);
                    let endpoint = '/api/usuarios';

                    if (userRole === 'gerente') {
                        endpoint = `/api/usuarios?gerenteId=${userId}`;
                    }

                    const response = await apiRequest(endpoint);
                    const data = await response.json();
                    setUsuarios(data);
                } catch (err) {
                    console.error('Erro ao buscar usu√°rios:', err);
                    setError('N√£o foi poss√≠vel carregar os usu√°rios.');
                } finally {
                    setLoading(false);
                }
            }, [userRole, userId]);

            const fetchRegioesAndGerentes = useCallback(async () => {
                try {
                    const [regioesRes, gerentesRes] = await Promise.all([
                        apiRequest('/api/regioes'),
                        apiRequest('/api/usuarios?tipo=gerente_regional')
                    ]);
                    const regioesData = await regioesRes.json();
                    const gerentesData = await gerentesRes.json();
                    setRegioesDisponiveis(regioesData.map(r => r.regiao));
                    setGerentesDisponiveis(gerentesData);
                } catch (err) {
                    console.error('Erro ao buscar dados de apoio para usu√°rios:', err);
                }
            }, []);

            useEffect(() => {
                if (user) {
                    fetchUsuarios();
                    fetchRegioesAndGerentes();
                }
            }, [user, fetchUsuarios, fetchRegioesAndGerentes]);

            const handleEdit = (user) => {
                setCurrentUser(user);
                setIsModalOpen(true);
            };

            const handleDelete = async (id) => {
                if (window.confirm('Tem certeza que deseja excluir este usu√°rio?')) {
                    try {
                        await apiRequest(`/api/usuarios/${id}`, { method: 'DELETE' });
                        fetchUsuarios();
                    } catch (err) {
                        console.error('Erro ao excluir usu√°rio:', err);
                        setError('N√£o foi poss√≠vel excluir o usu√°rio.');
                    }
                }
            };

            const handleSave = async (userData) => {
                try {
                    if (userData.id) {
                        await apiRequest(`/api/usuarios/${userData.id}`, {
                            method: 'PUT',
                            body: userData,
                        });
                    } else {
                        await apiRequest('/api/usuarios', {
                            method: 'POST',
                            body: userData,
                        });
                    }
                    fetchUsuarios();
                    setIsModalOpen(false);
                    setCurrentUser(null);
                } catch (err) {
                    console.error('Erro ao salvar usu√°rio:', err);
                    setError('N√£o foi poss√≠vel salvar o usu√°rio.');
                }
            };

            const filteredUsuarios = useMemo(() => {
                return usuarios.filter(usuario => {
                    const matchesSearch = searchTerm === '' ||
                        usuario.nome.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        usuario.email.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesRole = filterRole === '' || usuario.tipo === filterRole;
                    const matchesRegiao = filterRegiao === '' || usuario.regiao === filterRegiao;
                    return matchesSearch && matchesRole && matchesRegiao;
                });
            }, [usuarios, searchTerm, filterRole, filterRegiao]);

            if (loading) return <div className="p-6 text-center">Carregando usu√°rios...</div>;
            if (error) return <div className="p-6 text-center text-red-600">Erro: {error}</div>;

            return (
                <div className="p-6">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6">Gerenciamento de Usu√°rios</h1>

                    <div className="flex justify-between items-center mb-4">
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                placeholder="Buscar usu√°rios..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            />
                            <select
                                value={filterRole}
                                onChange={(e) => setFilterRole(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            >
                                <option value="">Todos os Cargos</option>
                                <option value="admin">Admin</option>
                                <option value="diretor">Diretor</option>
                                <option value="gerente_regional">Gerente Regional</option>
                                <option value="captador">Captador</option>
                            </select>
                            <select
                                value={filterRegiao}
                                onChange={(e) => setFilterRegiao(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            >
                                <option value="">Todas as Regi√µes</option>
                                {regioesDisponiveis.map(regiao => (
                                    <option key={regiao} value={regiao}>{regiao}</option>
                                ))}
                            </select>
                        </div>
                        <button
                            onClick={() => { setCurrentUser(null); setIsModalOpen(true); }}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center"
                        >
                            <Icon name="Plus" /> Novo Usu√°rio
                        </button>
                    </div>

                    <div className="bg-white shadow overflow-hidden sm:rounded-lg">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cargo</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Regi√£o</th>
                                    <th scope="col" className="relative px-6 py-3"><span className="sr-only">A√ß√µes</span></th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {filteredUsuarios.map((usuario) => (
                                    <tr key={usuario.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{usuario.nome}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{usuario.email}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{usuario.tipo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{usuario.regiao}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => handleEdit(usuario)} className="text-blue-600 hover:text-blue-900 mr-3"><Icon name="Edit" /></button>
                                            <button onClick={() => handleDelete(usuario.id)} className="text-red-600 hover:text-red-900"><Icon name="X" /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {isModalOpen && (
                        <UsuarioModal
                            usuario={currentUser}
                            onSave={handleSave}
                            onClose={() => setIsModalOpen(false)}
                            regioesDisponiveis={regioesDisponiveis}
                            gerentesDisponiveis={gerentesDisponiveis}
                        />
                    )}
                </div>
            );
        };

        // Modal para Adicionar/Editar Usu√°rio
        const UsuarioModal = ({ usuario, onSave, onClose, regioesDisponiveis, gerentesDisponiveis }) => {
            const [formData, setFormData] = useState(usuario || {
                nome: '',
                email: '',
                senha: '',
                tipo: 'captador',
                regiao: '',
                regioes_responsavel: '',
                gerente_responsavel_id: '',
            });

            useEffect(() => {
                setFormData(usuario || {
                    nome: '',
                    email: '',
                    senha: '',
                    tipo: 'captador',
                    regiao: '',
                    regioes_responsavel: '',
                    gerente_responsavel_id: '',
                });
            }, [usuario]);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            const isGerenteRegional = formData.tipo === 'gerente_regional';
            const isCaptador = formData.tipo === 'captador';

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
                    <div className="relative p-8 border w-full max-w-2xl md:max-w-3xl shadow-lg rounded-md bg-white">
                        <h3 className="text-lg font-medium leading-6 text-gray-900 mb-4">
                            {usuario ? 'Editar Usu√°rio' : 'Novo Usu√°rio'}
                        </h3>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label htmlFor="nome" className="block text-sm font-medium text-gray-700">Nome</label>
                                <input type="text" name="nome" id="nome" value={formData.nome} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" name="email" id="email" value={formData.email} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            {!usuario && (
                                <div>
                                    <label htmlFor="senha" className="block text-sm font-medium text-gray-700">Senha</label>
                                    <input type="password" name="senha" id="senha" value={formData.senha} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required={!usuario} />
                                </div>
                            )}
                            <div>
                                <label htmlFor="tipo" className="block text-sm font-medium text-gray-700">Cargo</label>
                                <select name="tipo" id="tipo" value={formData.tipo} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                    <option value="admin">Admin</option>
                                    <option value="diretor">Diretor</option>
                                    <option value="gerente_regional">Gerente Regional</option>
                                    <option value="captador">Captador</option>
                                </select>
                            </div>
                            <div>
                                <label htmlFor="regiao" className="block text-sm font-medium text-gray-700">Regi√£o</label>
                                <select name="regiao" id="regiao" value={formData.regiao} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                    <option value="">Selecione uma regi√£o</option>
                                    {regioesDisponiveis.map(regiao => (
                                        <option key={regiao} value={regiao}>{regiao}</option>
                                    ))}
                                </select>
                            </div>
                            {isGerenteRegional && (
                                <div>
                                    <label htmlFor="regioes_responsavel" className="block text-sm font-medium text-gray-700">Regi√µes Respons√°veis (separar por v√≠rgula)</label>
                                    <input type="text" name="regioes_responsavel" id="regioes_responsavel" value={formData.regioes_responsavel} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                                </div>
                            )}
                            {isCaptador && (
                                <div>
                                    <label htmlFor="gerente_responsavel_id" className="block text-sm font-medium text-gray-700">Gerente Respons√°vel</label>
                                    <select name="gerente_responsavel_id" id="gerente_responsavel_id" value={formData.gerente_responsavel_id} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Nenhum</option>
                                        {gerentesDisponiveis.map(gerente => (
                                            <option key={gerente.id} value={gerente.id}>{gerente.nome}</option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            <div className="md:col-span-2 flex justify-end space-x-3 mt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    className="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Componente de Relat√≥rios
        const Relatorios = () => {
            const { user } = useAuth();
            const [relatorios, setRelatorios] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentRelatorio, setCurrentRelatorio] = useState(null);
            const [filterTipo, setFilterTipo] = useState('');
            const [filterRegiao, setFilterRegiao] = useState('');
            const [regioesDisponiveis, setRegioesDisponiveis] = useState([]);

            const userRole = localStorage.getItem('role');
            const userId = user?.id;

            const fetchRelatorios = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);
                    let endpoint = '/api/relatorios';

                    if (userRole === 'gerente') {
                        endpoint = `/api/relatorios?gerenteId=${userId}`;
                    }

                    const response = await apiRequest(endpoint);
                    const data = await response.json();
                    setRelatorios(data);
                } catch (err) {
                    console.error('Erro ao buscar relat√≥rios:', err);
                    setError('N√£o foi poss√≠vel carregar os relat√≥rios.');
                } finally {
                    setLoading(false);
                }
            }, [userRole, userId]);

            const fetchRegioes = useCallback(async () => {
                try {
                    const response = await apiRequest('/api/regioes');
                    const data = await response.json();
                    setRegioesDisponiveis(data.map(r => r.regiao));
                } catch (err) {
                    console.error('Erro ao buscar regi√µes:', err);
                }
            }, []);

            useEffect(() => {
                if (user) {
                    fetchRelatorios();
                    fetchRegioes();
                }
            }, [user, fetchRelatorios, fetchRegioes]);

            const handleGenerateReport = async (reportData) => {
                try {
                    await apiRequest('/api/relatorios', {
                        method: 'POST',
                        body: { ...reportData, gerado_por_id: user.id },
                    });
                    fetchRelatorios();
                    setIsModalOpen(false);
                } catch (err) {
                    console.error('Erro ao gerar relat√≥rio:', err);
                    setError('N√£o foi poss√≠vel gerar o relat√≥rio.');
                }
            };

            const handleDelete = async (id) => {
                if (window.confirm('Tem certeza que deseja excluir este relat√≥rio?')) {
                    try {
                        await apiRequest(`/api/relatorios/${id}`, { method: 'DELETE' });
                        fetchRelatorios();
                    } catch (err) {
                        console.error('Erro ao excluir relat√≥rio:', err);
                        setError('N√£o foi poss√≠vel excluir o relat√≥rio.');
                    }
                }
            };

            const filteredRelatorios = useMemo(() => {
                return relatorios.filter(relatorio => {
                    const matchesType = filterTipo === '' || relatorio.tipo === filterTipo;
                    const matchesRegiao = filterRegiao === '' || relatorio.regiao === filterRegiao;
                    return matchesType && matchesRegiao;
                });
            }, [relatorios, filterTipo, filterRegiao]);

            if (loading) return <div className="p-6 text-center">Carregando relat√≥rios...</div>;
            if (error) return <div className="p-6 text-center text-red-600">Erro: {error}</div>;

            return (
                <div className="p-6">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6">Gerenciamento de Relat√≥rios</h1>

                    <div className="flex justify-between items-center mb-4">
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                placeholder="Buscar relat√≥rios..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            />
                            <select
                                value={filterTipo}
                                onChange={(e) => setFilterTipo(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            >
                                <option value="">Todos os Tipos</option>
                                <option value="demandas">Demandas</option>
                                <option value="missoes">Miss√µes</option>
                                <option value="performance">Performance</option>
                                <option value="geral">Geral</option>
                            </select>
                            <select
                                value={filterRegiao}
                                onChange={(e) => setFilterRegiao(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md"
                            >
                                <option value="">Todas as Regi√µes</option>
                                {regioesDisponiveis.map(regiao => (
                                    <option key={regiao} value={regiao}>{regiao}</option>
                                ))}
                            </select>
                        </div>
                        <button
                            onClick={() => setIsModalOpen(true)}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center"
                        >
                            <Icon name="Plus" /> Gerar Novo Relat√≥rio
                        </button>
                    </div>

                    <div className="bg-white shadow overflow-hidden sm:rounded-lg">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√≠tulo</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Regi√£o</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gerado Por</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Gera√ß√£o</th>
                                    <th scope="col" className="relative px-6 py-3"><span className="sr-only">A√ß√µes</span></th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {filteredRelatorios.map((relatorio) => (
                                    <tr key={relatorio.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{relatorio.titulo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{relatorio.tipo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{relatorio.regiao || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{relatorio.gerado_por_nome || 'Desconhecido'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(relatorio.data_geracao).toLocaleDateString()}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => alert('Visualizar relat√≥rio: ' + relatorio.titulo)} className="text-blue-600 hover:text-blue-900 mr-3"><Icon name="Eye" /></button>
                                            <button onClick={() => handleDelete(relatorio.id)} className="text-red-600 hover:text-red-900"><Icon name="X" /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {isModalOpen && (
                        <RelatorioModal
                            onSave={handleGenerateReport}
                            onClose={() => setIsModalOpen(false)}
                            regioesDisponiveis={regioesDisponiveis}
                        />
                    )}
                </div>
            );
        };

        // Modal para Gerar Relat√≥rio
        const RelatorioModal = ({ onSave, onClose, regioesDisponiveis }) => {
            const [formData, setFormData] = useState({
                titulo: '',
                tipo: 'demandas',
                filtros: '',
                regiao: '',
                data_inicio: '',
                data_fim: '',
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
                    <div className="relative p-8 border w-full max-w-2xl md:max-w-3xl shadow-lg rounded-md bg-white">
                        <h3 className="text-lg font-medium leading-6 text-gray-900 mb-4">
                            Gerar Novo Relat√≥rio
                        </h3>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label htmlFor="titulo" className="block text-sm font-medium text-gray-700">T√≠tulo do Relat√≥rio</label>
                                <input type="text" name="titulo" id="titulo" value={formData.titulo} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required />
                            </div>
                            <div>
                                <label htmlFor="tipo" className="block text-sm font-medium text-gray-700">Tipo de Relat√≥rio</label>
                                <select name="tipo" id="tipo" value={formData.tipo} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                    <option value="demandas">Demandas</option>
                                    <option value="missoes">Miss√µes</option>
                                    <option value="performance">Performance</option>
                                    <option value="geral">Geral</option>
                                </select>
                            </div>
                            <div>
                                <label htmlFor="regiao" className="block text-sm font-medium text-gray-700">Regi√£o (Opcional)</label>
                                <select name="regiao" id="regiao" value={formData.regiao} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Todas</option>
                                    {regioesDisponiveis.map(regiao => (
                                        <option key={regiao} value={regiao}>{regiao}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label htmlFor="data_inicio" className="block text-sm font-medium text-gray-700">Data In√≠cio (Opcional)</label>
                                <input type="date" name="data_inicio" id="data_inicio" value={formData.data_inicio} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="data_fim" className="block text-sm font-medium text-gray-700">Data Fim (Opcional)</label>
                                <input type="date" name="data_fim" id="data_fim" value={formData.data_fim} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div className="md:col-span-2">
                                <label htmlFor="filtros" className="block text-sm font-medium text-gray-700">Filtros Adicionais (JSON, Opcional)</label>
                                <textarea name="filtros" id="filtros" value={formData.filtros} onChange={handleChange} rows="3" className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                            </div>
                            <div className="md:col-span-2 flex justify-end space-x-3 mt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    className="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Gerar Relat√≥rio
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Componente de Configura√ß√µes
        const Configuracoes = () => {
            const { user } = useAuth();
            const [configuracoes, setConfiguracoes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentConfig, setCurrentConfig] = useState(null);
            const [regioesDisponiveis, setRegioesDisponiveis] = useState([]);
            const [gerentesDisponiveis, setGerentesDisponiveis] = useState([]);

            const userRole = localStorage.getItem('role');

            const fetchConfiguracoes = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);
                    const response = await apiRequest('/api/configuracoes-regionais');
                    const data = await response.json();
                    setConfiguracoes(data);
                } catch (err) {
                    console.error('Erro ao buscar configura√ß√µes:', err);
                    setError('N√£o foi poss√≠vel carregar as configura√ß√µes regionais.');
                } finally {
                    setLoading(false);
                }
            }, []);

            const fetchRegioesAndGerentes = useCallback(async () => {
                try {
                    const [regioesRes, gerentesRes] = await Promise.all([
                        apiRequest('/api/regioes'),
                        apiRequest('/api/usuarios?tipo=gerente_regional')
                    ]);
                    const regioesData = await regioesRes.json();
                    const gerentesData = await gerentesRes.json();
                    setRegioesDisponiveis(regioesData.map(r => r.regiao));
                    setGerentesDisponiveis(gerentesData);
                } catch (err) {
                    console.error('Erro ao buscar dados de apoio para configura√ß√µes:', err);
                }
            }, []);

            useEffect(() => {
                if (user) {
                    fetchConfiguracoes();
                    fetchRegioesAndGerentes();
                }
            }, [user, fetchConfiguracoes, fetchRegioesAndGerentes]);

            const handleEdit = (config) => {
                setCurrentConfig(config);
                setIsModalOpen(true);
            };

            const handleDelete = async (id) => {
                if (window.confirm('Tem certeza que deseja excluir esta configura√ß√£o regional?')) {
                    try {
                        await apiRequest(`/api/configuracoes-regionais/${id}`, { method: 'DELETE' });
                        fetchConfiguracoes();
                    } catch (err) {
                        console.error('Erro ao excluir configura√ß√£o:', err);
                        setError('N√£o foi poss√≠vel excluir a configura√ß√£o regional.');
                    }
                }
            };

            const handleSave = async (configData) => {
                try {
                    if (configData.id) {
                        await apiRequest(`/api/configuracoes-regionais/${configData.id}`, {
                            method: 'PUT',
                            body: configData,
                        });
                    } else {
                        await apiRequest('/api/configuracoes-regionais', {
                            method: 'POST',
                            body: configData,
                        });
                    }
                    fetchConfiguracoes();
                    setIsModalOpen(false);
                    setCurrentConfig(null);
                } catch (err) {
                    console.error('Erro ao salvar configura√ß√£o:', err);
                    setError('N√£o foi poss√≠vel salvar a configura√ß√£o regional.');
                }
            };

            if (loading) return <div className="p-6 text-center">Carregando configura√ß√µes...</div>;
            if (error) return <div className="p-6 text-center text-red-600">Erro: {error}</div>;

            return (
                <div className="p-6">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6">Configura√ß√µes Regionais</h1>

                    <div className="flex justify-end items-center mb-4">
                        <button
                            onClick={() => { setCurrentConfig(null); setIsModalOpen(true); }}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center"
                        >
                            <Icon name="Plus" /> Nova Configura√ß√£o
                        </button>
                    </div>

                    <div className="bg-white shadow overflow-hidden sm:rounded-lg">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Regi√£o</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gerente Respons√°vel</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo</th>
                                    <th scope="col" className="relative px-6 py-3"><span className="sr-only">A√ß√µes</span></th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {configuracoes.map((config) => (
                                    <tr key={config.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{config.regiao}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{gerentesDisponiveis.find(g => g.id === config.gerente_responsavel_id)?.nome || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{config.ativo ? 'Sim' : 'N√£o'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => handleEdit(config)} className="text-blue-600 hover:text-blue-900 mr-3"><Icon name="Edit" /></button>
                                            <button onClick={() => handleDelete(config.id)} className="text-red-600 hover:text-red-900"><Icon name="X" /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {isModalOpen && (
                        <ConfiguracaoModal
                            configuracao={currentConfig}
                            onSave={handleSave}
                            onClose={() => setIsModalOpen(false)}
                            regioesDisponiveis={regioesDisponiveis}
                            gerentesDisponiveis={gerentesDisponiveis}
                        />
                    )}
                </div>
            );
        };

        // Componente de Roteamento
        const AppRouter = () => {
            const { user, loading } = useAuth();

            if (loading) {
                return <div className="min-h-screen flex items-center justify-center">Carregando...</div>;
            }

            if (!user) {
                return <LoginForm />;
            }

            const path = window.location.hash;

            let content;
            if (path.startsWith('#demandas')) {
                content = <Demandas />;
            } else if (path.startsWith('#missoes')) {
                content = <Missoes />;
            } else if (path.startsWith('#usuarios')) {
                content = <Usuarios />;
            } else if (path.startsWith('#relatorios')) {
                content = <Relatorios />;
            } else if (path.startsWith('#configuracoes')) {
                content = <Configuracoes />;
            } else {
                content = <Dashboard />;
            }

            return (
                <Layout>
                    {content}
                </Layout>
            );
        };

        // Renderiza√ß√£o principal
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(
            <AuthProvider>
                <AppRouter />
            </AuthProvider>
        );
    </script>
</body>
</html>
