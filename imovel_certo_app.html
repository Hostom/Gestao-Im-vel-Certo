<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Capta√ß√£o - Im√≥vel Certo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .kanban-column { min-height: 400px; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- Backend API Configuration ---
        // As chamadas de API est√£o temporariamente desabilitadas e simuladas com dados locais.
        // Quando seu backend no Railway estiver pronto, remova os dados mocados e reative as chamadas 'fetch'.
        const API_URL = 'https://sua-api.railway.app'; // Coloque a URL da sua API no Railway aqui quando estiver pronta.

        const { useState, useEffect, Fragment } = React;
        const { createRoot } = ReactDOM;

        // --- DADOS VINDOS DA SUA PLANILHA 'Listas.csv' ---
        const listas = {
            consultores: ["Israel", "Matheus", "Bruna K", "Kerolin", "Stephanie"],
            captadores: ["Bruna S", "Michele", "Morgana"],
            tiposImovel: ["Apartamento", "Casa", "Sala Comercial", "Loja", "Galp√£o", "Terreno"],
            finalidade: ["Residencial", "Comercial"],
            prazos: ["Urgente", "At√© 7 dias", "At√© 15 dias"],
            statusMissao: ["Em busca", "Encontrado", "Locado", "Sem op√ß√£o"],
            bairros: ["Centro", "Pioneiros", "Barra Norte", "Meia Praia", "Morretes", "Taboleiro"],
            faixaAluguel: ["De 8mil a 10mil", "De 10mil a 12mil", "De 12mil a 15mil", "De 15mil a 20mil", "De 20mil a 25mil", "De 25 mil a 30mil", "Acima de 30mil"]
        };
        
        // --- DADOS MOCADOS PARA SIMULAR O BACKEND ---
        const mockDemandas = [
            { id: 'dem1', codigoDemanda: 'LOC-A1B2', consultorLocacao: 'Matheus', clienteInteressado: 'Thiago', contato: '606060606', tipoImovel: 'Apartamento', regiaoDesejada: 'Centro', faixaAluguel: '8000', caracteristicasDesejadas: 'Frente mar', prazoNecessidade: 'Urgente', observacoes: 'frente para o rio', dataSolicitacao: new Date().toISOString() },
        ];

        const mockMissoes = [
            { id: 'mis1', codigoDemanda: 'LOC-A1B2', dataMissao: new Date(Date.now() - 10 * 3600 * 1000).toISOString(), captadorResponsavel: 'Bruna S', consultorSolicitante: 'Matheus', regiaoBairro: 'Centro', descricaoBusca: 'Frente mar', status: 'Em busca', dataRetorno: null },
            { id: 'mis2', codigoDemanda: 'LOC-C3D4', dataMissao: new Date(Date.now() - 50 * 3600 * 1000).toISOString(), captadorResponsavel: 'Michele', consultorSolicitante: 'Israel', regiaoBairro: 'Meia Praia', descricaoBusca: '3 su√≠tes, 2 vagas', status: 'Encontrado', dataRetorno: new Date(Date.now() - 2 * 3600 * 1000).toISOString() },
            { id: 'mis3', codigoDemanda: 'LOC-E5F6', dataMissao: new Date(Date.now() - 120 * 3600 * 1000).toISOString(), captadorResponsavel: 'Morgana', consultorSolicitante: 'Bruna K', regiaoBairro: 'Pioneiros', descricaoBusca: 'Cobertura duplex', status: 'Locado', dataRetorno: new Date(Date.now() - 90 * 3600 * 1000).toISOString() },
        ];


        // --- MAIN APP COMPONENT ---
        function App() {
            const [view, setView] = useState('missoes_captacao');
            const [missoes, setMissoes] = useState([]);
            const [demandas, setDemandas] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // Fun√ß√£o para carregar os dados (agora simulada)
            const fetchData = async () => {
                setLoading(true);
                setError(null);
                // Simula uma chamada de API com 0.5s de atraso
                setTimeout(() => {
                    setMissoes(mockMissoes);
                    setDemandas(mockDemandas);
                    setLoading(false);
                }, 500);

                /*
                // C√ìDIGO REAL DA API (REATIVE QUANDO O BACKEND ESTIVER PRONTO)
                try {
                    setLoading(true);
                    const missoesRes = await fetch(`${API_URL}/api/missoes`);
                    const demandasRes = await fetch(`${API_URL}/api/demandas`);
                    
                    if (!missoesRes.ok || !demandasRes.ok) {
                        throw new Error('Falha ao buscar dados da API. Verifique se o backend est√° rodando.');
                    }
                    const missoesData = await missoesRes.json();
                    const demandasData = await demandasRes.json();
                    setMissoes(missoesData);
                    setDemandas(demandasData);
                } catch (err) {
                    console.error("Fetch error:", err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
                */
            };
            
            useEffect(() => {
                fetchData();
            }, []);

            const addDemanda = async (novaDemanda) => {
                // Simula√ß√£o local: A l√≥gica da roleta √© simulada aqui.
                const ultimoCaptador = missoes.length > 0 ? missoes.sort((a,b) => new Date(b.dataMissao) - new Date(a.dataMissao))[0].captadorResponsavel : listas.captadores[listas.captadores.length - 1];
                const ultimoIndex = listas.captadores.indexOf(ultimoCaptador);
                const proximoCaptador = listas.captadores[(ultimoIndex + 1) % listas.captadores.length];

                const novaMissao = {
                    id: `mis${Date.now()}`,
                    codigoDemanda: `LOC-${Date.now().toString().slice(-4)}`,
                    dataMissao: new Date().toISOString(),
                    captadorResponsavel: proximoCaptador,
                    consultorSolicitante: novaDemanda.consultorLocacao,
                    regiaoBairro: novaDemanda.regiaoDesejada,
                    descricaoBusca: novaDemanda.caracteristicasDesejadas,
                    status: 'Em busca',
                    dataRetorno: null
                };
                
                setMissoes(prev => [...prev, novaMissao]);
                setDemandas(prev => [...prev, { ...novaDemanda, id: `dem${Date.now()}` }]);
                setView('missoes_captacao');

                /*
                // C√ìDIGO REAL DA API (REATIVE QUANDO O BACKEND ESTIVER PRONTO)
                try {
                    const response = await fetch(`${API_URL}/api/demandas`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novaDemanda)
                    });
                    if (!response.ok) throw new Error('Falha ao criar nova demanda.');
                    await fetchData();
                    setView('missoes_captacao');
                } catch(err) {
                    console.error("Error adding document: ", err);
                    alert("Erro ao adicionar demanda. Verifique o console para mais detalhes.");
                }
                */
            };
            
            const updateMissaoStatus = async (missaoId, novoStatus) => {
                // Simula√ß√£o local
                setMissoes(prevMissoes => prevMissoes.map(m => 
                    m.id === missaoId ? { ...m, status: novoStatus, dataRetorno: (novoStatus === 'Encontrado' || novoStatus === 'Locado') ? new Date().toISOString() : m.dataRetorno } : m
                ));

                /*
                // C√ìDIGO REAL DA API (REATIVE QUANDO O BACKEND ESTIVER PRONTO)
                 try {
                    const response = await fetch(`${API_URL}/api/missoes/${missaoId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: novoStatus })
                    });
                     if (!response.ok) throw new Error('Falha ao atualizar o status da miss√£o.');
                    // Atualiza o estado local para uma resposta visual imediata
                    setMissoes(prevMissoes => prevMissoes.map(m => 
                        m.id === missaoId ? { ...m, status: novoStatus } : m
                    ));
                 } catch(err) {
                    console.error("Error updating status: ", err);
                    alert("Erro ao atualizar status. O Kanban pode n√£o refletir a mudan√ßa.");
                 }
                */
            };

            const renderView = () => {
                switch (view) {
                    case 'power_bi':
                        return <PowerBIDashboard />;
                    case 'demandas_locacao':
                        return <DemandasLocacao onAddDemanda={addDemanda} />;
                    case 'missoes_captacao':
                        return <MissoesCaptacao missoes={missoes} onUpdateStatus={updateMissaoStatus} />;
                    case 'ranking_captadores':
                        return <RankingCaptadores missoes={missoes} />;
                    default:
                        return <MissoesCaptacao missoes={missoes} onUpdateStatus={updateMissaoStatus} />;
                }
            };

            if (error) {
                return (
                    <div className="flex items-center justify-center h-screen">
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-md max-w-lg text-center">
                            <strong className="font-bold">Erro de Conex√£o!</strong>
                            <p className="block sm:inline mt-2">{error}</p>
                            <p className="mt-2 text-sm">Certifique-se que sua API est√° rodando no Railway e acess√≠vel.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex">
                    <nav className="w-64 bg-gray-800 text-white p-5 flex flex-col">
                        <h1 className="text-2xl font-bold mb-10">Im√≥vel Certo</h1>
                        <ul>
                            <NavItem icon="üìã" text="Miss√µes de Capta√ß√£o" active={view === 'missoes_captacao'} onClick={() => setView('missoes_captacao')} />
                            <NavItem icon="‚ûï" text="Nova Demanda" active={view === 'demandas_locacao'} onClick={() => setView('demandas_locacao')} />
                            <NavItem icon="üèÜ" text="Ranking Captadores" active={view === 'ranking_captadores'} onClick={() => setView('ranking_captadores')} />
                            <NavItem icon="üìä" text="Dashboard Power BI" active={view === 'power_bi'} onClick={() => setView('power_bi')} />
                        </ul>
                    </nav>
                    <main className="flex-1 p-10">
                        {loading ? <div className="text-center text-xl">Carregando dados...</div> : renderView()}
                    </main>
                </div>
            );
        }

        const NavItem = ({ icon, text, active, onClick }) => (
            <li className={`mb-4 cursor-pointer p-3 rounded-lg flex items-center ${active ? 'bg-blue-600' : 'hover:bg-gray-700'}`} onClick={onClick}>
                <span className="mr-3 text-xl">{icon}</span>
                <span className="font-medium">{text}</span>
            </li>
        );
        
        function PowerBIDashboard() {
            // TODO: Substitua a URL abaixo pela URL p√∫blica do seu relat√≥rio Power BI
            const powerBiUrl = "https://app.powerbi.com/view?r=eyJrIjoiYOUR_REPORT_ID_HERE....";

            return (
                 <Fragment>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8">Painel Executivo (Power BI)</h2>
                    <div className="bg-white p-6 rounded-lg shadow-md text-center">
                         <p className="text-gray-700 mb-6">Os indicadores de performance e KPIs s√£o visualizados atrav√©s do nosso dashboard no Power BI, que se conecta diretamente ao nosso banco de dados para an√°lises ricas e detalhadas.</p>
                         <a 
                            href={powerBiUrl} 
                            target="_blank" 
                            rel="noopener noreferrer" 
                            className="inline-block bg-yellow-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-yellow-600 transition duration-300"
                        >
                            Abrir Dashboard no Power BI
                        </a>
                        <p className="text-xs text-gray-500 mt-4">O Power BI pode levar alguns segundos para carregar os dados mais recentes.</p>
                    </div>
                </Fragment>
            );
        }

        function DemandasLocacao({ onAddDemanda }) {
            const [demanda, setDemanda] = useState({
                consultorLocacao: '', clienteInteressado: '', contato: '', tipoImovel: '', regiaoDesejada: '',
                faixaAluguel: '8000', caracteristicasDesejadas: '', prazoNecessidade: '', observacoes: '',
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setDemanda(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (parseFloat(demanda.faixaAluguel.replace(/[^0-9]/g, '')) < 8000) {
                     alert("Apenas demandas com aluguel acima de R$8.000,00 podem ser enviadas para capta√ß√£o.");
                     return;
                }
                onAddDemanda(demanda);
                setDemanda({
                    consultorLocacao: '', clienteInteressado: '', contato: '', tipoImovel: '', regiaoDesejada: '',
                    faixaAluguel: '8000', caracteristicasDesejadas: '', prazoNecessidade: '', observacoes: '',
                });
            };

            return (
                <Fragment>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8">Nova Demanda de Loca√ß√£o</h2>
                    <form onSubmit={handleSubmit} className="bg-white p-8 rounded-lg shadow-md space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <InputField name="consultorLocacao" label="Consultor de Loca√ß√£o" type="select" options={listas.consultores} value={demanda.consultorLocacao} onChange={handleChange} required />
                            <InputField name="clienteInteressado" label="Cliente Interessado" value={demanda.clienteInteressado} onChange={handleChange} required />
                            <InputField name="contato" label="Telefone / Contato" value={demanda.contato} onChange={handleChange} required />
                            <InputField name="tipoImovel" label="Tipo de Im√≥vel" type="select" options={listas.tiposImovel} value={demanda.tipoImovel} onChange={handleChange} required />
                            <InputField name="regiaoDesejada" label="Regi√£o / Bairro Desejado" type="select" options={listas.bairros} value={demanda.regiaoDesejada} onChange={handleChange} required />
                            <InputField name="faixaAluguel" label="Faixa de Aluguel (R$)" type="number" min="8000" value={demanda.faixaAluguel} onChange={handleChange} required />
                        </div>
                        <InputField name="caracteristicasDesejadas" label="Caracter√≠sticas Desejadas" type="textarea" value={demanda.caracteristicasDesejadas} onChange={handleChange} />
                        <InputField name="prazoNecessidade" label="Prazo de Necessidade" type="select" options={listas.prazos} value={demanda.prazoNecessidade} onChange={handleChange} />
                        <InputField name="observacoes" label="Observa√ß√µes" type="textarea" value={demanda.observacoes} onChange={handleChange} />
                        <div className="flex justify-end">
                            <button type="submit" className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                                Enviar para Capta√ß√£o (Roleta)
                            </button>
                        </div>
                    </form>
                </Fragment>
            );
        }

        const InputField = ({ name, label, type = 'text', options = [], ...props }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                {type === 'select' ? (
                    <select id={name} name={name} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" {...props}>
                        <option value="">Selecione...</option>
                        {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                    </select>
                ) : type === 'textarea' ? (
                    <textarea id={name} name={name} rows="3" className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" {...props}></textarea>
                ) : (
                    <input type={type} id={name} name={name} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" {...props} />
                )}
            </div>
        );


        function MissoesCaptacao({ missoes, onUpdateStatus }) {
            const columns = listas.statusMissao;

            const handleDrop = (e, targetStatus) => {
                e.preventDefault();
                const missaoId = e.dataTransfer.getData("missaoId");
                onUpdateStatus(missaoId, targetStatus);
            };

            const handleDragOver = (e) => { e.preventDefault(); };
            const handleDragStart = (e, missaoId) => { e.dataTransfer.setData("missaoId", missaoId); };

            return (
                <Fragment>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8">Miss√µes de Capta√ß√£o (Kanban)</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {columns.map(status => (
                            <div key={status} onDrop={(e) => handleDrop(e, status)} onDragOver={handleDragOver} className="bg-gray-200 p-4 rounded-lg kanban-column">
                                <h3 className="font-bold text-lg mb-4 text-center text-gray-700">{status} ({missoes.filter(m => m.status === status).length})</h3>
                                <div className="space-y-4">
                                    {missoes.filter(m => m.status === status).map(missao => (
                                        <MissaoCard key={missao.id} missao={missao} onDragStart={handleDragStart} />
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </Fragment>
            );
        }

        function MissaoCard({ missao, onDragStart }) {
            const dataMissao = new Date(missao.dataMissao);
            const prazo = new Date(dataMissao.getTime() + 48 * 60 * 60 * 1000);
            const agora = new Date();
            const horasRestantes = (prazo - agora) / (1000 * 60 * 60);

            let prazoColor = 'text-green-600';
            if (horasRestantes <= 24) prazoColor = 'text-yellow-600';
            if (horasRestantes <= 12) prazoColor = 'text-red-600';
            if (horasRestantes <= 0) prazoColor = 'text-red-800 font-bold';
            
            return (
                <div draggable onDragStart={(e) => onDragStart(e, missao.id)} className="bg-white p-4 rounded-lg shadow-md cursor-grab active:cursor-grabbing">
                    <div className="flex justify-between items-start">
                        <span className="font-bold text-blue-700">{missao.codigoDemanda}</span>
                        <span className="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-1 rounded-full">{missao.captadorResponsavel}</span>
                    </div>
                    <p className="text-sm text-gray-700 mt-2">{missao.regiaoBairro}: {missao.descricaoBusca}</p>
                    <div className="text-xs text-gray-500 mt-3 pt-3 border-t">
                        <p>Consultor: {missao.consultorSolicitante}</p>
                        <p className={`mt-1 font-medium ${prazoColor}`}>
                            Prazo: {horasRestantes > 0 ? `${Math.floor(horasRestantes)}h restantes` : 'Expirado'}
                        </p>
                    </div>
                </div>
            );
        }

        function RankingCaptadores({ missoes }) {
             const captadorStats = listas.captadores.map(captador => {
                const missoesDoCaptador = missoes.filter(m => m.captadorResponsavel === captador);
                const totalMissoes = missoesDoCaptador.length;
                const encontrados = missoesDoCaptador.filter(m => m.status === 'Encontrado' || m.status === 'Locado').length;
                const locados = missoesDoCaptador.filter(m => m.status === 'Locado').length;
                const taxaConversao = totalMissoes > 0 ? (locados / totalMissoes * 100) : 0;
                
                const tempos = missoesDoCaptador
                    .filter(m => m.dataMissao && m.dataRetorno)
                    .map(m => (new Date(m.dataRetorno) - new Date(m.dataMissao)) / (1000*60*60));
                
                const tempoMedio = tempos.length > 0 ? (tempos.reduce((a, b) => a + b, 0) / tempos.length) : 0;

                return {
                    nome: captador,
                    totalMissoes,
                    encontrados,
                    locados,
                    taxaConversao: taxaConversao.toFixed(1),
                    tempoMedio: tempoMedio.toFixed(1)
                };
            }).sort((a,b) => b.locados - a.locados || a.tempoMedio - b.tempoMedio);

            return (
                 <Fragment>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8">Ranking de Captadores</h2>
                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <table className="min-w-full leading-normal">
                            <thead>
                                <tr className="bg-gray-200 text-left text-gray-600 uppercase text-sm">
                                    <th className="px-5 py-3">Pos.</th>
                                    <th className="px-5 py-3">Captador</th>
                                    <th className="px-5 py-3">Total Miss√µes</th>
                                    <th className="px-5 py-3">Encontrados</th>
                                    <th className="px-5 py-3">Locados</th>
                                    <th className="px-5 py-3">Taxa Convers√£o (%)</th>
                                    <th className="px-5 py-3">Tempo M√©dio (h)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {captadorStats.map((stats, index) => (
                                    <tr key={stats.nome} className="border-b border-gray-200 hover:bg-gray-100">
                                        <td className="px-5 py-4 text-lg font-bold">{index + 1}</td>
                                        <td className="px-5 py-4 font-medium">{stats.nome}</td>
                                        <td className="px-5 py-4">{stats.totalMissoes}</td>
                                        <td className="px-5 py-4">{stats.encontrados}</td>
                                        <td className="px-5 py-4 text-green-600 font-bold">{stats.locados}</td>
                                        <td className="px-5 py-4">{stats.taxaConversao}%</td>
                                        <td className="px-5 py-4">{stats.tempoMedio}h</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Fragment>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

